<div class="parent-student-learning">
  <div class="page-header-compact mb-3">
    <div class="header-with-back">
      <p-button icon="pi pi-chevron-left" [rounded]="true" [text]="true" routerLink="/parent" title="Back to My Students" styleClass="mr-2" />
      <div *ngIf="overview">
        <h1 class="page-title-inline">{{ overview.studentName }}</h1>
        <p class="page-desc-short">Learning overview (read-only). Grade {{ overview.gradeLevel }}. Master Doc 11C C1.</p>
      </div>
      <div *ngIf="!overview">
        <h1 class="page-title-inline">{{ loading ? 'Loading...' : 'Learning overview' }}</h1>
      </div>
    </div>
  </div>

  <p-message *ngIf="error" severity="error" [text]="error" styleClass="w-full mb-3" />

  <div *ngIf="loading" class="p-4 text-center text-color-secondary"><i class="pi pi-spin pi-spinner mr-2"></i>Loading...</div>

  <ng-container *ngIf="overview && !loading && !error">
    <div class="subscription-banner" *ngIf="overview.subscriptionValidUntil">
      <strong>Subscription until {{ overview.subscriptionValidUntil | date:'shortDate' }}</strong> for {{ overview.studentName }}.
    </div>

    <p-card header="Assigned teacher(s)" styleClass="section-card">
      <div *ngIf="overview.assignedTeachers.length === 0" class="empty-state-inline">No active One-To-One class.</div>
      <ul class="list" *ngIf="overview.assignedTeachers.length > 0">
        <li *ngFor="let t of overview.assignedTeachers">
          {{ t.teacherName }} – {{ t.contractIdDisplay }}<span *ngIf="t.subscriptionPeriodEnd"> until {{ t.subscriptionPeriodEnd | date:'shortDate' }}</span>
        </li>
      </ul>
    </p-card>

    <p-card header="Subjects" styleClass="section-card">
      <p class="value">{{ overview.subjects || '—' }}</p>
    </p-card>

    <p-card header="Subscription" styleClass="section-card" *ngIf="overview.subscriptionValidUntil">
      <p class="value">Valid until {{ overview.subscriptionValidUntil | date:'shortDate' }}</p>
    </p-card>

    <p-card header="Calendar (month)" styleClass="section-card">
      <p class="hint">Month view: holidays, completed classes, and upcoming classes for {{ overview.studentName }}.</p>
      <div class="month-nav">
        <p-button icon="pi pi-chevron-left" [outlined]="true" (onClick)="prevMonth()" title="Previous month" />
        <span class="month-label">{{ monthLabel }}</span>
        <p-button icon="pi pi-chevron-right" [outlined]="true" (onClick)="nextMonth()" title="Next month" />
        <p-button label="This month" [outlined]="true" severity="secondary" (onClick)="thisMonth()" />
      </div>
      <div class="legend mb-2">
        <span class="legend-item"><span class="dot completed"></span> Completed</span>
        <span class="legend-item"><span class="dot upcoming"></span> Upcoming</span>
        <span class="legend-item"><span class="dot holiday"></span> Holiday</span>
      </div>
      <div *ngIf="monthLoading" class="loading-inline"><i class="pi pi-spin pi-spinner mr-2"></i>Loading...</div>
      <div *ngIf="!monthLoading" class="month-grid">
        <div class="month-row header-row">
          <div *ngFor="let h of dayHeaders" class="month-cell header-cell">{{ h }}</div>
        </div>
        <div *ngFor="let week of calendarWeeks" class="month-row">
          <div *ngFor="let cell of week" class="month-cell day-cell"
               [class.other-month]="!cell.isCurrentMonth"
               [class.today]="cell.isToday">
            <div class="day-num">{{ cell.dayOfMonth }}</div>
            <ng-container *ngIf="cell.date">
              <div *ngIf="holidayOnDay(cell.date) as holiday" class="day-holiday">
                <span class="holiday-badge">{{ holiday.name }}</span>
              </div>
              <div class="day-sessions">
                <div *ngFor="let s of monthSessionsOnDay(cell.date)" class="session-block"
                     [class.completed]="isMonthSessionCompleted(s)"
                     [class.upcoming]="isMonthSessionUpcoming(s)">
                  <div class="session-time">{{ s.startTime }}<span *ngIf="s.endTime"> – {{ s.endTime }}</span></div>
                  <div class="session-meta">
                    <span *ngIf="s.groupClassName">Group: {{ s.groupClassName }}</span>
                    <span *ngIf="!s.groupClassName">{{ s.teacherName }} · {{ s.contractIdDisplay }}</span>
                    <span *ngIf="isMonthSessionCompleted(s)" class="status-badge completed">Completed</span>
                    <span *ngIf="isMonthSessionUpcoming(s)" class="status-badge upcoming">Upcoming</span>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </p-card>

    <p-card header="This week (quick view)" styleClass="section-card">
      <p class="hint">Sessions this week for {{ overview.studentName }}.</p>
      <div class="week-nav">
        <p-button icon="pi pi-chevron-left" [outlined]="true" (onClick)="prevWeek()" title="Previous week" />
        <span class="week-label">{{ weekLabel }}</span>
        <p-button icon="pi pi-chevron-right" [outlined]="true" (onClick)="nextWeek()" title="Next week" />
        <p-button label="This week" [outlined]="true" severity="secondary" (onClick)="thisWeek()" />
      </div>
      <div *ngIf="weekLoading" class="loading-inline"><i class="pi pi-spin pi-spinner mr-2"></i>Loading...</div>
      <div *ngIf="!weekLoading" class="week-grid">
        <div *ngFor="let col of dayColumns" class="day-column" [class.today]="col.isToday">
          <div class="day-header">
            <span class="day-name">{{ col.label }}</span>
            <span class="day-date">{{ col.date | date:'d MMM' }}</span>
          </div>
          <div class="day-sessions">
            <div *ngFor="let s of sessionsOnDay(col.date)" class="session-block">
              <div class="session-time">{{ s.startTime }}<span *ngIf="s.endTime"> – {{ s.endTime }}</span></div>
              <div class="session-meta">{{ s.teacherName }} · {{ s.contractIdDisplay }} · {{ s.status }}</div>
            </div>
            <div *ngIf="sessionsOnDay(col.date).length === 0" class="no-sessions">—</div>
          </div>
        </div>
      </div>
    </p-card>

    <p-card header="Active One-To-One classes (can attend)" styleClass="section-card">
      <p class="hint">Teacher delivers sessions; Admin confirms. Renew via Admin when needed.</p>
      <div *ngIf="overview.upcomingSessions.length === 0" class="empty-state-inline">None.</div>
      <ul class="list" *ngIf="overview.upcomingSessions.length > 0">
        <li *ngFor="let u of overview.upcomingSessions">
          {{ u.teacherName }} – {{ u.contractIdDisplay }}<span *ngIf="u.subscriptionPeriodEnd"> until {{ u.subscriptionPeriodEnd | date:'shortDate' }}</span>
        </li>
      </ul>
    </p-card>

    <p-card header="Completed sessions" styleClass="section-card">
      <p class="hint">Past sessions with lesson notes and progress (read-only).</p>
      <div *ngIf="overview.completedSessions.length === 0" class="empty-state-inline">No completed sessions yet.</div>
      <div *ngFor="let c of overview.completedSessions" class="session-card">
        <div class="session-header">
          {{ c.teacherName }} · {{ c.checkInTime | displayDate:'short' }}
          <span *ngIf="c.checkOutTime"> – {{ c.checkOutTime | displayDate:'short' }}</span>
          · {{ c.hoursUsed | number:'1.1-1' }} hrs
        </div>
        <div class="session-notes" *ngIf="c.lessonNotes">
          <strong>Lesson notes:</strong> {{ c.lessonNotes }}
        </div>
        <div class="session-progress" *ngIf="c.progressReport">
          <strong>Progress:</strong> {{ c.progressReport }}
        </div>
      </div>
    </p-card>

    <p-card header="Homework" styleClass="section-card">
      <p class="hint">Assignments from teachers (read-only).</p>
      <div *ngIf="!overview.homeworks?.length" class="empty-state-inline">No homework yet.</div>
      <div *ngFor="let h of overview.homeworks || []" class="session-card">
        <div class="session-header">{{ h.title }} · {{ h.teacherName }} · Due {{ h.dueDate | displayDate:'shortDate' }} · {{ h.statusText }}</div>
        <div class="session-notes" *ngIf="h.description">{{ h.description }}</div>
        <div class="session-notes" *ngIf="h.teacherFeedback"><strong>Teacher feedback:</strong> {{ h.teacherFeedback }}</div>
      </div>
    </p-card>

    <p-card header="Grades" styleClass="section-card">
      <p class="hint">Grades and assessments from teachers (read-only).</p>
      <div *ngIf="!overview.grades?.length" class="empty-state-inline">No grades yet.</div>
      <div *ngFor="let g of overview.grades || []" class="session-card">
        <div class="session-header">{{ g.title }} · {{ g.teacherName }} · {{ g.gradeValue }}{{ g.maxValue != null ? ' / ' + g.maxValue : '' }} · {{ g.gradeDate | displayDate:'shortDate' }}</div>
        <div class="session-notes" *ngIf="g.notes">{{ g.notes }}</div>
      </div>
    </p-card>
  </ng-container>
</div>
