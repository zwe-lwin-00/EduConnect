<div class="admin-group-classes">
  <div class="page-header-compact">
    <div>
      <h1>Group classes</h1>
      <p class="page-desc-short">Set up class (name, teacher, days, start/end time), assign students. Zoom link is added by the assigned teacher.</p>
    </div>
    <button type="button" class="btn btn-primary" (click)="openCreate()">New class</button>
  </div>

  <div *ngIf="error" class="error">{{ error }}</div>
  <div *ngIf="loading" class="loading">Loading...</div>

  <div *ngIf="!loading && groupClasses.length === 0" class="empty">No group classes. Click &quot;New class&quot; to add one.</div>

  <table *ngIf="!loading && groupClasses.length > 0" class="data-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Teacher</th>
        <th>Schedule</th>
        <th>Zoom</th>
        <th>Active</th>
        <th>Enrolled</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let gc of groupClasses; let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ gc.name }}</td>
        <td>{{ gc.teacherName || '—' }}</td>
        <td>{{ formatSchedule(gc) }}</td>
        <td>{{ gc.zoomJoinUrl ? 'Set' : '—' }}</td>
        <td>{{ gc.isActive ? 'Yes' : 'No' }}</td>
        <td>{{ gc.enrolledCount }}</td>
        <td>
          <button type="button" class="btn btn-sm btn-secondary" (click)="openEdit(gc)">Edit</button>
          <button type="button" class="btn btn-sm btn-secondary" (click)="openEnrollments(gc)">Enrollments</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Create modal -->
  <div *ngIf="showCreate" class="modal-overlay" (click)="showCreate = false">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Create group class</h3>
        <button type="button" class="btn-close" (click)="showCreate = false">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" [(ngModel)]="newName" class="form-control" placeholder="e.g. Grade 2 Math" />
        </div>
        <div class="form-group">
          <label>Assign teacher *</label>
          <select [(ngModel)]="newTeacherId" class="form-control">
            <option [ngValue]="null">-- Select teacher --</option>
            <option *ngFor="let t of teachers" [ngValue]="t.id">{{ t.firstName }} {{ t.lastName }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Days of week</label>
          <div class="days-checkboxes">
            <label *ngFor="let d of dayOptions" class="day-check"><input type="checkbox" [value]="d.value" [(ngModel)]="d.checked" (ngModelChange)="onNewDayChange()" /> {{ d.label }}</label>
          </div>
        </div>
        <div class="form-group form-row">
          <div>
            <label>Start time</label>
            <input type="time" [(ngModel)]="newStartTime" class="form-control" />
          </div>
          <div>
            <label>End time</label>
            <input type="time" [(ngModel)]="newEndTime" class="form-control" />
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" (click)="showCreate = false">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="create()" [disabled]="creating || !(newName || '').trim() || newTeacherId == null">{{ creating ? 'Creating...' : 'Create' }}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit modal -->
  <div *ngIf="showEdit && selectedClass" class="modal-overlay" (click)="showEdit = false">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Edit group class</h3>
        <button type="button" class="btn-close" (click)="showEdit = false">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" [(ngModel)]="editName" class="form-control" />
        </div>
        <div class="form-group">
          <label>Assign teacher *</label>
          <select [(ngModel)]="editTeacherId" class="form-control">
            <option *ngFor="let t of teachers" [ngValue]="t.id">{{ t.firstName }} {{ t.lastName }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Days of week</label>
          <div class="days-checkboxes">
            <label *ngFor="let d of editDayOptions" class="day-check"><input type="checkbox" [value]="d.value" [(ngModel)]="d.checked" (ngModelChange)="onEditDayChange()" /> {{ d.label }}</label>
          </div>
        </div>
        <div class="form-group form-row">
          <div>
            <label>Start time</label>
            <input type="time" [(ngModel)]="editStartTime" class="form-control" />
          </div>
          <div>
            <label>End time</label>
            <input type="time" [(ngModel)]="editEndTime" class="form-control" />
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-label"><input type="checkbox" [(ngModel)]="editIsActive" /> Active</label>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" (click)="showEdit = false">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="update()" [disabled]="updating">{{ updating ? 'Saving...' : 'Save' }}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enrollments modal -->
  <div *ngIf="showEnrollments && selectedClass" class="modal-overlay" (click)="closeEnrollments()">
    <div class="modal modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ selectedClass.name }} – Students</h3>
        <button type="button" class="btn-close" (click)="closeEnrollments()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="add-enroll-inline" *ngIf="assignableContracts.length > 0">
          <select [(ngModel)]="enrollContractId" class="form-control inline-select">
            <option [ngValue]="null">Add student...</option>
            <option *ngFor="let c of assignableContracts" [ngValue]="c.id">{{ c.studentName }} – {{ c.contractId }}</option>
          </select>
          <button type="button" class="btn btn-primary" (click)="enroll()" [disabled]="!enrollContractId || enrolling">{{ enrolling ? '...' : 'Add' }}</button>
        </div>
        <p class="hint small" *ngIf="assignableContracts.length === 0 && enrollments.length > 0">All eligible students are enrolled.</p>
        <p class="hint small" *ngIf="assignableContracts.length === 0 && enrollments.length === 0">No active contracts with {{ selectedClass.teacherName }}. Create a contract first.</p>
        <ul class="enrollment-list">
          <li *ngFor="let e of enrollments" class="enrollment-item">
            <span>{{ e.studentName }} – {{ e.contractIdDisplay || e.subscriptionIdDisplay || '—' }}</span>
            <button type="button" class="btn btn-sm btn-danger" (click)="unenroll(e.id)">Remove</button>
          </li>
          <li *ngIf="enrollments.length === 0" class="empty">No enrollments.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
