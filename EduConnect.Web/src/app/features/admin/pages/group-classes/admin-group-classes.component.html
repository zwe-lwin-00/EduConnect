<div class="admin-group-classes">
  <div class="page-header-compact">
    <div>
      <h1>Group classes</h1>
      <p class="page-desc-short">Create a group class, assign a teacher, then enroll students who have an active Group subscription (add subscriptions on the Subscriptions page first).</p>
    </div>
    <p-button label="New class" icon="pi pi-plus" severity="success" (onClick)="openCreate()" />
  </div>

  <p-message *ngIf="error" severity="error" [text]="error" styleClass="w-full mb-3" />

  <p-card>
    <p-table
      [value]="groupClasses"
      [loading]="loading"
      [tableStyle]="{ 'min-width': '50rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true">
      <ng-template pTemplate="header">
        <tr>
          <th style="width:3rem">#</th>
          <th>Name</th>
          <th>Teacher</th>
          <th>Schedule</th>
          <th>Zoom</th>
          <th>Active</th>
          <th>Enrolled</th>
          <th style="width:12rem">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-gc let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ gc.name }}</td>
          <td>{{ gc.teacherName || '—' }}</td>
          <td>{{ formatSchedule(gc) }}</td>
          <td>{{ gc.zoomJoinUrl ? 'Set' : '—' }}</td>
          <td>{{ gc.isActive ? 'Yes' : 'No' }}</td>
          <td>{{ gc.enrolledCount }}</td>
          <td>
            <p-button label="Edit" icon="pi pi-pencil" [outlined]="true" size="small" (onClick)="openEdit(gc)" class="mr-1" />
            <p-button label="Enrollments" icon="pi pi-users" [outlined]="true" size="small" (onClick)="openEnrollments(gc)" />
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8">
            <div class="empty-table-message">
              <i class="pi pi-book empty-icon"></i>
              <p>No group classes.</p>
              <p class="empty-hint">Click &quot;New class&quot; to add one.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-dialog
    header="Create group class"
    [(visible)]="showCreate"
    [modal]="true"
    [style]="{ width: '28rem' }"
    [draggable]="false"
    [resizable]="false"
    (onHide)="showCreate = false">
    <div class="dialog-form">
      <div class="field">
        <label>Name *</label>
        <input pInputText type="text" [(ngModel)]="newName" class="w-full" placeholder="e.g. Grade 2 Math" />
      </div>
      <div class="field">
        <label>Assign teacher *</label>
        <select [(ngModel)]="newTeacherId" class="p-inputtext w-full">
          <option [ngValue]="null">-- Select teacher --</option>
          <option *ngFor="let t of teachers" [ngValue]="t.id">{{ t.firstName }} {{ t.lastName }}</option>
        </select>
      </div>
      <div class="field">
        <label>Days of week</label>
        <div class="days-checkboxes">
          <label *ngFor="let d of dayOptions" class="day-check"><input type="checkbox" [value]="d.value" [(ngModel)]="d.checked" (ngModelChange)="onNewDayChange()" /> {{ d.label }}</label>
        </div>
      </div>
      <div class="field form-row">
        <div><label>Start time</label><input pInputText type="time" [(ngModel)]="newStartTime" class="w-full" /></div>
        <div><label>End time</label><input pInputText type="time" [(ngModel)]="newEndTime" class="w-full" /></div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="showCreate = false" />
      <p-button label="Create" icon="pi pi-check" (onClick)="create()" [loading]="creating" [disabled]="!(newName || '').trim() || newTeacherId == null" />
    </ng-template>
  </p-dialog>

  <p-dialog
    header="Edit group class"
    [(visible)]="showEdit"
    [modal]="true"
    [style]="{ width: '28rem' }"
    [draggable]="false"
    [resizable]="false"
    (onHide)="showEdit = false"
    *ngIf="selectedClass">
    <div class="dialog-form">
      <div class="field">
        <label>Name *</label>
        <input pInputText type="text" [(ngModel)]="editName" class="w-full" />
      </div>
      <div class="field">
        <label>Assign teacher *</label>
        <select [(ngModel)]="editTeacherId" class="p-inputtext w-full">
          <option *ngFor="let t of teachers" [ngValue]="t.id">{{ t.firstName }} {{ t.lastName }}</option>
        </select>
      </div>
      <div class="field">
        <label>Days of week</label>
        <div class="days-checkboxes">
          <label *ngFor="let d of editDayOptions" class="day-check"><input type="checkbox" [value]="d.value" [(ngModel)]="d.checked" (ngModelChange)="onEditDayChange()" /> {{ d.label }}</label>
        </div>
      </div>
      <div class="field form-row">
        <div><label>Start time</label><input pInputText type="time" [(ngModel)]="editStartTime" class="w-full" /></div>
        <div><label>End time</label><input pInputText type="time" [(ngModel)]="editEndTime" class="w-full" /></div>
      </div>
      <div class="field">
        <label class="checkbox-label"><input type="checkbox" [(ngModel)]="editIsActive" /> Active</label>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="showEdit = false" />
      <p-button label="Save" icon="pi pi-check" (onClick)="update()" [loading]="updating" />
    </ng-template>
  </p-dialog>

  <p-dialog
    [header]="selectedClass.name + ' – Students'"
    [(visible)]="showEnrollments"
    [modal]="true"
    [style]="{ width: '32rem' }"
    [draggable]="false"
    (onHide)="closeEnrollments()"
    *ngIf="selectedClass">
    <div class="enrollments-content">
      <div class="enroll-section">
        <span class="enroll-section-label">By Group subscription</span>
        <div class="add-enroll-inline" *ngIf="assignableGroupSubscriptions.length > 0">
          <select [(ngModel)]="enrollSubscriptionId" class="p-inputtext inline-select" (ngModelChange)="enrollContractId = null">
            <option [ngValue]="null">Select student with Group subscription...</option>
            <option *ngFor="let sub of assignableGroupSubscriptions" [ngValue]="sub.id">{{ subscriptionOptionLabel(sub) }}</option>
          </select>
          <p-button label="Enroll" icon="pi pi-plus" (onClick)="enroll()" [loading]="enrolling" [disabled]="!enrollSubscriptionId" />
        </div>
        <p class="hint small" *ngIf="assignableGroupSubscriptions.length === 0">No students with active Group subscription (or all are already enrolled). Add Group subscriptions on the Subscriptions page.</p>
      </div>
      <div class="enroll-section">
        <span class="enroll-section-label">By One-to-one contract (same teacher)</span>
        <div class="add-enroll-inline" *ngIf="assignableContracts.length > 0">
          <select [(ngModel)]="enrollContractId" class="p-inputtext inline-select" (ngModelChange)="enrollSubscriptionId = null">
            <option [ngValue]="null">Select contract...</option>
            <option *ngFor="let c of assignableContracts" [ngValue]="c.id">{{ c.studentName }} – {{ c.contractId }}</option>
          </select>
          <p-button label="Enroll" icon="pi pi-plus" (onClick)="enroll()" [loading]="enrolling" [disabled]="!enrollContractId" />
        </div>
        <p class="hint small" *ngIf="assignableContracts.length === 0 && assignableGroupSubscriptions.length === 0 && enrollments.length > 0">All eligible students are enrolled.</p>
        <p class="hint small" *ngIf="assignableContracts.length === 0 && assignableGroupSubscriptions.length > 0">No extra One-to-one contracts with this teacher.</p>
      </div>
      <ul class="enrollment-list">
        <li *ngFor="let e of enrollments" class="enrollment-item">
          <span>{{ e.studentName }} – {{ e.contractIdDisplay || e.subscriptionIdDisplay || '—' }}</span>
          <p-button label="Remove" icon="pi pi-times" severity="danger" [outlined]="true" size="small" (onClick)="unenroll(e.id)" />
        </li>
        <li *ngIf="enrollments.length === 0" class="empty-enroll">No enrollments.</li>
      </ul>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Done" (onClick)="closeEnrollments()" />
    </ng-template>
  </p-dialog>
</div>
