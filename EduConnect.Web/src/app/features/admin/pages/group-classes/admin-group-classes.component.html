<div class="admin-group-classes page-container">
  <div class="page-header-compact">
    <div>
      <h1>Group classes</h1>
      <p class="page-desc-short">Create a group class, assign a teacher, then enroll students who have an active Group subscription (add subscriptions on the Subscriptions page first).</p>
    </div>
    <p-button label="New class" icon="pi pi-plus" severity="success" (onClick)="openCreate()" />
  </div>

  <p-message *ngIf="error" severity="error" [text]="error" styleClass="w-full mb-3" />

  <p-card styleClass="table-card">
    <p-table
      [value]="groupClasses"
      [loading]="loading"
      [tableStyle]="{ 'min-width': '50rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} classes"
      [showCurrentPageReport]="true">
      <ng-template pTemplate="header">
        <tr>
          <th style="width:3rem">#</th>
          <th>Name</th>
          <th>Teacher</th>
          <th>Schedule</th>
          <th>Zoom</th>
          <th>Active</th>
          <th>Enrolled</th>
          <th style="width:12rem">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-gc let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ gc.name }}</td>
          <td>{{ gc.teacherName || '—' }}</td>
          <td>{{ formatSchedule(gc) }}</td>
          <td>{{ gc.zoomJoinUrl ? 'Set' : '—' }}</td>
          <td>{{ gc.isActive ? 'Yes' : 'No' }}</td>
          <td>{{ gc.enrolledCount }}</td>
          <td>
            <p-button label="Edit" icon="pi pi-pencil" [outlined]="true" size="small" (onClick)="openEdit(gc)" class="mr-1" />
            <p-button label="Enrollments" icon="pi pi-users" [outlined]="true" size="small" (onClick)="openEnrollments(gc)" />
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8">
            <div class="empty-table-message">
              <i class="pi pi-book empty-icon"></i>
              <p>No group classes.</p>
              <p class="empty-hint">Click &quot;New class&quot; to add one.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-dialog
    appendTo="body"
    header="Create group class"
    [(visible)]="showCreate"
    [modal]="true"
    [style]="{ width: '28rem' }"
    [draggable]="false"
    [resizable]="false"
    (onHide)="showCreate = false">
    <div class="dialog-form">
      <div class="field">
        <label>Name *</label>
        <input pInputText type="text" [(ngModel)]="newName" class="w-full" placeholder="e.g. Grade 2 Math" />
      </div>
      <div class="field">
        <label>Assign teacher *</label>
        <p-dropdown appendTo="body" [(ngModel)]="newTeacherId" [options]="teacherOptions" optionLabel="label" optionValue="value" placeholder="Select teacher" styleClass="w-full" />
      </div>
      <div class="field">
        <label>Days of week</label>
        <div class="days-checkboxes flex gap-2 flex-wrap">
          <div *ngFor="let d of dayOptions" class="flex align-items-center gap-1">
            <p-checkbox [inputId]="'new-day-' + d.value" [(ngModel)]="d.checked" (ngModelChange)="onNewDayChange()" [binary]="true" />
            <label [for]="'new-day-' + d.value" class="day-check">{{ d.label }}</label>
          </div>
        </div>
      </div>
      <div class="field form-row">
        <div class="field"><label>From date</label><p-calendar appendTo="body" [(ngModel)]="newFromDate" [minDate]="createFromDateMin" dateFormat="yy-mm-dd" placeholder="Optional" styleClass="w-full" (ngModelChange)="onNewFromDateChange()" /></div>
        <div class="field"><label>To date</label><p-calendar appendTo="body" [(ngModel)]="newToDate" [minDate]="createToDateMin" dateFormat="yy-mm-dd" placeholder="Optional" styleClass="w-full" /></div>
      </div>
      <div class="field form-row">
        <div class="field"><label>Start time</label><p-calendar [(ngModel)]="newStartTime" [timeOnly]="true" hourFormat="12" placeholder="Start" styleClass="w-full" /></div>
        <div class="field"><label>End time</label><p-calendar [(ngModel)]="newEndTime" [timeOnly]="true" hourFormat="12" placeholder="End" styleClass="w-full" /></div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="showCreate = false" />
      <p-button label="Create" icon="pi pi-check" (onClick)="create()" [loading]="creating" [disabled]="!(newName || '').trim() || newTeacherId == null" />
    </ng-template>
  </p-dialog>

  <p-dialog
    appendTo="body"
    header="Edit group class"
    [(visible)]="showEdit"
    [modal]="true"
    [style]="{ width: '28rem' }"
    [draggable]="false"
    [resizable]="false"
    (onHide)="showEdit = false"
    *ngIf="selectedClass">
    <div class="dialog-form">
      <div class="field">
        <label>Name *</label>
        <input pInputText type="text" [(ngModel)]="editName" class="w-full" />
      </div>
      <div class="field">
        <label>Assign teacher *</label>
        <p-dropdown appendTo="body" [(ngModel)]="editTeacherId" [options]="teacherOptions" optionLabel="label" optionValue="value" placeholder="Select teacher" styleClass="w-full" />
      </div>
      <div class="field">
        <label>Days of week</label>
        <div class="days-checkboxes flex gap-2 flex-wrap">
          <div *ngFor="let d of editDayOptions" class="flex align-items-center gap-1">
            <p-checkbox [inputId]="'edit-day-' + d.value" [(ngModel)]="d.checked" (ngModelChange)="onEditDayChange()" [binary]="true" />
            <label [for]="'edit-day-' + d.value" class="day-check">{{ d.label }}</label>
          </div>
        </div>
      </div>
      <div class="field form-row">
        <div class="field"><label>From date</label><p-calendar appendTo="body" [(ngModel)]="editFromDate" [minDate]="editFromDateMin" dateFormat="yy-mm-dd" placeholder="Optional" styleClass="w-full" (ngModelChange)="onEditFromDateChange()" /></div>
        <div class="field"><label>To date</label><p-calendar appendTo="body" [(ngModel)]="editToDate" [minDate]="editToDateMin" dateFormat="yy-mm-dd" placeholder="Optional" styleClass="w-full" /></div>
      </div>
      <div class="field form-row">
        <div class="field"><label>Start time</label><p-calendar [(ngModel)]="editStartTime" [timeOnly]="true" hourFormat="12" placeholder="Start" styleClass="w-full" /></div>
        <div class="field"><label>End time</label><p-calendar [(ngModel)]="editEndTime" [timeOnly]="true" hourFormat="12" placeholder="End" styleClass="w-full" /></div>
      </div>
      <div class="field flex align-items-center gap-2">
        <p-checkbox [(ngModel)]="editIsActive" [binary]="true" inputId="editIsActive" />
        <label for="editIsActive" class="checkbox-label">Active</label>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="showEdit = false" />
      <p-button label="Save" icon="pi pi-check" (onClick)="update()" [loading]="updating" />
    </ng-template>
  </p-dialog>

  <p-dialog
    appendTo="body"
    [header]="selectedClass.name + ' – Students'"
    [(visible)]="showEnrollments"
    [modal]="true"
    [style]="{ width: '32rem' }"
    [draggable]="false"
    (onHide)="closeEnrollments()"
    *ngIf="selectedClass">
    <div class="enrollments-content">
      <div class="enroll-section">
        <span class="enroll-section-label">By Group subscription</span>
        <div class="add-enroll-inline flex gap-2 flex-wrap" *ngIf="assignableGroupSubscriptions.length > 0">
          <p-dropdown appendTo="body" [(ngModel)]="enrollSubscriptionId" [options]="enrollSubscriptionOptions" optionLabel="label" optionValue="value" placeholder="Select student with Group subscription..." styleClass="inline-select" (ngModelChange)="enrollContractId = null" [style]="{ minWidth: '16rem' }" />
          <p-button label="Enroll" icon="pi pi-plus" (onClick)="enroll()" [loading]="enrolling" [disabled]="!enrollSubscriptionId" />
        </div>
        <p class="hint small" *ngIf="assignableGroupSubscriptions.length === 0">No students with active Group subscription (or all are already enrolled). Add Group subscriptions on the Subscriptions page.</p>
      </div>
      <div class="enroll-section">
        <span class="enroll-section-label">By One-to-one contract (same teacher)</span>
        <div class="add-enroll-inline flex gap-2 flex-wrap" *ngIf="assignableContracts.length > 0">
          <p-dropdown appendTo="body" [(ngModel)]="enrollContractId" [options]="enrollContractOptions" optionLabel="label" optionValue="value" placeholder="Select contract..." styleClass="inline-select" (ngModelChange)="enrollSubscriptionId = null" [style]="{ minWidth: '16rem' }" />
          <p-button label="Enroll" icon="pi pi-plus" (onClick)="enroll()" [loading]="enrolling" [disabled]="!enrollContractId" />
        </div>
        <p class="hint small" *ngIf="assignableContracts.length === 0 && assignableGroupSubscriptions.length === 0 && enrollments.length > 0">All eligible students are enrolled.</p>
        <p class="hint small" *ngIf="assignableContracts.length === 0 && assignableGroupSubscriptions.length > 0">No extra One-to-one contracts with this teacher.</p>
      </div>
      <ul class="enrollment-list">
        <li *ngFor="let e of enrollments" class="enrollment-item">
          <span>{{ e.studentName }} – {{ e.contractIdDisplay || e.subscriptionIdDisplay || '—' }}</span>
          <p-button label="Remove" icon="pi pi-times" severity="danger" [outlined]="true" size="small" (onClick)="unenroll(e.id)" />
        </li>
        <li *ngIf="enrollments.length === 0" class="empty-enroll">No enrollments.</li>
      </ul>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Done" (onClick)="closeEnrollments()" />
    </ng-template>
  </p-dialog>
</div>
