<div class="admin-payments page-container">
  <div class="page-header-compact">
    <div>
      <h1>Subscriptions</h1>
      <p class="page-desc-short">Add parent-paid subscription months to students first. If the student already has the same type (One-to-one or Group), the period is extended instead of creating a new one. Use &quot;All statuses&quot; below to view full subscription history for tracing.</p>
    </div>
    <div class="flex gap-2">
      <p-button label="Add subscription" icon="pi pi-plus" severity="success" (onClick)="openAddSubscriptionPopup()" />
      <p-button label="Renew One-to-one class" icon="pi pi-calendar-plus" (onClick)="openRenewContractPopup()" [outlined]="true" />
    </div>
  </div>

  <p-card styleClass="table-card">
    <p-toolbar>
      <ng-template pTemplate="start">
        <span class="filter-group">
          <p-dropdown appendTo="body" [(ngModel)]="filterStudentId" [options]="studentFilterOptions" optionLabel="label" optionValue="value" placeholder="Student" styleClass="filter-select" (ngModelChange)="applyFilters()" />
          <p-dropdown appendTo="body" [(ngModel)]="filterType" [options]="typeOptions" optionLabel="label" optionValue="value" placeholder="Type" styleClass="filter-select" (ngModelChange)="applyFilters()" />
          <p-dropdown appendTo="body" [(ngModel)]="filterStatus" [options]="statusOptions" optionLabel="label" optionValue="value" placeholder="Status" styleClass="filter-select" (ngModelChange)="applyFilters()" />
          <p-button label="Apply" icon="pi pi-filter" (onClick)="applyFilters()" [outlined]="true" />
        </span>
      </ng-template>
    </p-toolbar>
    <p-table
      [value]="subscriptions"
      [loading]="loading"
      [tableStyle]="{ 'min-width': '50rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} subscriptions"
      [showCurrentPageReport]="true">
      <ng-template pTemplate="header">
        <tr>
          <th style="width:3rem">#</th>
          <th>Subscription</th>
          <th>Student</th>
          <th>Type</th>
          <th>Start date</th>
          <th>Period end</th>
          <th>Status</th>
          <th>Created at</th>
          <th style="width:8rem">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-sub let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ sub.subscriptionId }}</td>
          <td>{{ sub.studentName }}</td>
          <td><span class="type-badge" [class.type-one]="sub.type === 1" [class.type-group]="sub.type === 2">{{ sub.typeName }}</span></td>
          <td>{{ sub.startDate | date:'mediumDate' }}</td>
          <td>{{ sub.subscriptionPeriodEnd | date:'mediumDate' }}</td>
          <td>
            <p-tag [value]="sub.statusName" [severity]="isSubscriptionActive(sub) ? 'success' : 'secondary'" />
          </td>
          <td>{{ sub.createdAt | date:'short' }}</td>
          <td>
            <p-button
              *ngIf="isSubscriptionActive(sub)"
              icon="pi pi-calendar-plus"
              [outlined]="true"
              size="small"
              (onClick)="renewSubscription(sub)"
              [loading]="renewingSubscriptionId === sub.id"
              title="Renew 1 month" />
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9">
            <div class="empty-table-message">
              <i class="pi pi-wallet empty-icon"></i>
              <p>No subscriptions yet.</p>
              <p class="empty-hint">Create parent & students first, then click "Add subscription" to add paid months (One-to-one or Group) to a student. After that, create classes on One-To-One or Group pages.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-dialog appendTo="body" header="Add subscription (paid months to student)" [(visible)]="showAddSubscriptionPopup" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeAddSubscriptionPopup()">
    <form [formGroup]="addSubscriptionForm" (ngSubmit)="onSubmitAddSubscription()" class="dialog-form">
      <div class="field">
        <label class="label-required">Student <span class="required-asterisk">*</span></label>
        <select formControlName="studentId" class="p-inputtext w-full">
          <option [ngValue]="null">Select student</option>
          <option *ngFor="let s of students" [ngValue]="s.id">{{ studentLabel(s) }}</option>
        </select>
      </div>
      <div class="field">
        <label class="label-required">Type <span class="required-asterisk">*</span></label>
        <select formControlName="type" class="p-inputtext w-full">
          <option [ngValue]="1">One-to-one class</option>
          <option [ngValue]="2">Group class</option>
        </select>
      </div>
      <div class="field">
        <label class="label-required">Duration (months) <span class="required-asterisk">*</span></label>
        <p-dropdown appendTo="body" formControlName="durationMonths" [options]="durationOptions" optionLabel="label" optionValue="value" placeholder="Select duration" styleClass="w-full" />
      </div>
    </form>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="closeAddSubscriptionPopup()" />
      <p-button label="Add subscription" icon="pi pi-check" (onClick)="onSubmitAddSubscription()" [disabled]="!addSubscriptionForm.valid" [loading]="creating" />
    </ng-template>
  </p-dialog>

  <p-dialog appendTo="body" header="Renew One-to-one class (by contract)" [(visible)]="showRenewContractPopup" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeRenewContractPopup()">
    <form [formGroup]="renewForm" (ngSubmit)="onSubmitRenewContract()" class="dialog-form">
      <div class="field">
        <label>One-to-one class</label>
        <p-dropdown appendTo="body" formControlName="contractId" [options]="contractDropdownOptions" optionLabel="label" optionValue="value" placeholder="Select class" styleClass="w-full" />
      </div>
    </form>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="closeRenewContractPopup()" />
      <p-button label="Renew 1 month" icon="pi pi-calendar-plus" (onClick)="onSubmitRenewContract()" [disabled]="!renewForm.valid" />
    </ng-template>
  </p-dialog>
</div>
