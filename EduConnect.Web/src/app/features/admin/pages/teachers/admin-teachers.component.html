<div class="admin-teachers page-container">
  <div class="page-header-compact">
    <div>
      <h1>Teachers</h1>
      <p class="page-desc-short">Onboard, verify, edit, and manage teacher accounts.</p>
    </div>
  </div>

  <p-card styleClass="table-card">
    <p-toolbar>
      <ng-template pTemplate="start">
        <p-button label="Onboard teacher" icon="pi pi-plus" severity="success" (onClick)="openOnboardPopup()" />
      </ng-template>
      <ng-template pTemplate="end">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search by name or email" class="global-filter-input" />
        </span>
      </ng-template>
    </p-toolbar>
    <p-table
      #dt
      [value]="teachers"
      [loading]="loading"
      [globalFilterFields]="['fullName','email']"
      [tableStyle]="{ 'min-width': '56rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} teachers"
      [showCurrentPageReport]="true">
      <ng-template pTemplate="header">
        <tr>
          <th style="width:3rem">#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Education</th>
          <th>Status</th>
          <th>Active</th>
          <th style="width:14rem">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-t let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ t.fullName }}</td>
          <td>{{ t.email }}</td>
          <td>{{ t.phoneNumber }}</td>
          <td>{{ t.educationLevel }}</td>
          <td><p-tag [value]="getVerificationStatusText(t.verificationStatus)" [severity]="getVerificationSeverity(t.verificationStatus)" /></td>
          <td>{{ t.isActive ? 'Yes' : 'No' }}</td>
          <td>
            <div class="action-buttons">
              <p-button icon="pi pi-eye" [outlined]="true" size="small" (onClick)="onViewTeacherDetails(t)" title="View" />
              <p-button icon="pi pi-pencil" [outlined]="true" size="small" (onClick)="openEditPopup(t)" title="Edit" />
              <p-button icon="pi pi-key" [outlined]="true" size="small" (onClick)="onResetTeacherPassword(t)" title="Reset password" />
              <p-button *ngIf="t.verificationStatus === 1" icon="pi pi-check" label="Verify" severity="success" [outlined]="true" size="small" (onClick)="onVerifyTeacher(t)" />
              <p-button *ngIf="t.verificationStatus === 1" icon="pi pi-times" label="Reject" severity="danger" [outlined]="true" size="small" (onClick)="openRejectDialog(t)" />
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8">
            <div class="empty-table-message">
              <i class="pi pi-users empty-icon"></i>
              <p>No teachers found.</p>
              <p class="empty-hint">Try adjusting your search or onboard a new teacher.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-dialog appendTo="body" header="Onboard new teacher" [(visible)]="showOnboardPopup" [modal]="true" [style]="{ width: '32rem' }" [draggable]="false" (onHide)="closeOnboardPopup()">
    <form [formGroup]="onboardForm" (ngSubmit)="onSubmitOnboard()" class="dialog-form">
      <div class="field">
        <label class="label-required" for="onboard-email">Email <span class="required-asterisk">*</span></label>
        <input pInputText id="onboard-email" type="email" formControlName="email" class="w-full" [class.p-invalid]="onboardForm.get('email')?.invalid && onboardForm.get('email')?.touched" />
        <small class="p-error" *ngIf="onboardForm.get('email')?.hasError('required') && onboardForm.get('email')?.touched">Email is required</small>
        <small class="p-error" *ngIf="onboardForm.get('email')?.hasError('email') && onboardForm.get('email')?.touched">Enter a valid email</small>
      </div>
      <div class="field">
        <label class="label-required" for="onboard-fullName">Full name <span class="required-asterisk">*</span></label>
        <input pInputText id="onboard-fullName" type="text" formControlName="fullName" class="w-full" [class.p-invalid]="onboardForm.get('fullName')?.invalid && onboardForm.get('fullName')?.touched" />
        <small class="p-error" *ngIf="onboardForm.get('fullName')?.invalid && onboardForm.get('fullName')?.touched">Full name is required</small>
      </div>
      <div class="field">
        <label class="label-required" for="onboard-phone">Phone <span class="required-asterisk">*</span></label>
        <input pInputText id="onboard-phone" type="text" formControlName="phoneNumber" class="w-full" [class.p-invalid]="onboardForm.get('phoneNumber')?.invalid && onboardForm.get('phoneNumber')?.touched" />
        <small class="p-error" *ngIf="onboardForm.get('phoneNumber')?.invalid && onboardForm.get('phoneNumber')?.touched">Phone is required</small>
      </div>
      <div class="field">
        <label class="label-required" for="onboard-nrc">NRC <span class="required-asterisk">*</span></label>
        <input pInputText id="onboard-nrc" type="text" formControlName="nrcNumber" class="w-full" [class.p-invalid]="onboardForm.get('nrcNumber')?.invalid && onboardForm.get('nrcNumber')?.touched" />
        <small class="p-error" *ngIf="onboardForm.get('nrcNumber')?.invalid && onboardForm.get('nrcNumber')?.touched">NRC is required</small>
      </div>
      <div class="field">
        <label class="label-required" for="onboard-education">Education <span class="required-asterisk">*</span></label>
        <input pInputText id="onboard-education" type="text" formControlName="educationLevel" class="w-full" [class.p-invalid]="onboardForm.get('educationLevel')?.invalid && onboardForm.get('educationLevel')?.touched" />
        <small class="p-error" *ngIf="onboardForm.get('educationLevel')?.invalid && onboardForm.get('educationLevel')?.touched">Education is required</small>
      </div>
      <div class="field">
        <label class="label-optional" for="onboard-bio">Bio <span class="optional-badge">Optional</span></label>
        <textarea pTextarea id="onboard-bio" formControlName="bio" class="w-full" rows="3"></textarea>
      </div>
      <div class="field">
        <label class="label-optional" for="onboard-specializations">Specializations <span class="optional-badge">Optional</span></label>
        <input pInputText id="onboard-specializations" type="text" formControlName="specializations" class="w-full" />
      </div>
    </form>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="closeOnboardPopup()" />
      <p-button label="Onboard" icon="pi pi-check" (onClick)="onSubmitOnboard()" [disabled]="!onboardForm.valid" />
    </ng-template>
  </p-dialog>

  <p-dialog appendTo="body" header="Share credentials" [(visible)]="showCredentialsPopup" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeCredentialsPopup()">
    <p class="mb-4">{{ credentialsNote }}</p>
    <div class="field"><label>Email</label><input pInputText type="text" [value]="credentialsEmail" readonly class="w-full" #emailInput (click)="emailInput.select()" /></div>
    <div class="field"><label>Temporary password</label><input pInputText type="text" [value]="credentialsPassword" readonly class="w-full" #pwdInput (click)="pwdInput.select()" /></div>
    <div class="flex gap-2 mt-4">
      <p-button label="Copy" icon="pi pi-copy" (onClick)="copyCredentialsToClipboard()" />
      <span *ngIf="copyFeedback" class="text-sm">{{ copyFeedback }}</span>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Done" (onClick)="closeCredentialsPopup()" />
    </ng-template>
  </p-dialog>

  <p-dialog appendTo="body" header="Edit teacher" [(visible)]="showEditPopup" [modal]="true" [style]="{ width: '32rem' }" [draggable]="false" (onHide)="closeEditPopup()">
    <form [formGroup]="editForm" (ngSubmit)="onSubmitEdit()" class="dialog-form">
      <div class="field">
        <label class="label-required" for="edit-fullName">Full name <span class="required-asterisk">*</span></label>
        <input pInputText id="edit-fullName" type="text" formControlName="fullName" class="w-full" [class.p-invalid]="editForm.get('fullName')?.invalid && editForm.get('fullName')?.touched" />
        <small class="p-error" *ngIf="editForm.get('fullName')?.invalid && editForm.get('fullName')?.touched">Full name is required</small>
      </div>
      <div class="field">
        <label class="label-required" for="edit-phone">Phone <span class="required-asterisk">*</span></label>
        <input pInputText id="edit-phone" type="text" formControlName="phoneNumber" class="w-full" [class.p-invalid]="editForm.get('phoneNumber')?.invalid && editForm.get('phoneNumber')?.touched" />
        <small class="p-error" *ngIf="editForm.get('phoneNumber')?.invalid && editForm.get('phoneNumber')?.touched">Phone is required</small>
      </div>
      <div class="field">
        <label class="label-required" for="edit-education">Education <span class="required-asterisk">*</span></label>
        <input pInputText id="edit-education" type="text" formControlName="educationLevel" class="w-full" [class.p-invalid]="editForm.get('educationLevel')?.invalid && editForm.get('educationLevel')?.touched" />
        <small class="p-error" *ngIf="editForm.get('educationLevel')?.invalid && editForm.get('educationLevel')?.touched">Education is required</small>
      </div>
      <div class="field">
        <label class="label-optional" for="edit-bio">Bio <span class="optional-badge">Optional</span></label>
        <textarea pTextarea id="edit-bio" formControlName="bio" class="w-full" rows="3"></textarea>
      </div>
      <div class="field">
        <label class="label-optional" for="edit-specializations">Specializations <span class="optional-badge">Optional</span></label>
        <input pInputText id="edit-specializations" type="text" formControlName="specializations" class="w-full" />
      </div>
    </form>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="closeEditPopup()" />
      <p-button label="Save" icon="pi pi-check" (onClick)="onSubmitEdit()" [disabled]="!editForm.valid" />
    </ng-template>
  </p-dialog>

  <p-dialog appendTo="body" [header]="selectedTeacher ? selectedTeacher.fullName : 'Teacher'" [(visible)]="showTeacherDetails" [modal]="true" [style]="{ width: '32rem' }" [draggable]="false" (onHide)="closeTeacherDetails()">
    <ng-container *ngIf="selectedTeacher">
      <div class="detail-panel">
        <div class="detail-row"><strong>Email:</strong> {{ selectedTeacher.email }}</div>
        <div class="detail-row"><strong>Phone:</strong> {{ selectedTeacher.phoneNumber }}</div>
        <div class="detail-row"><strong>Education:</strong> {{ selectedTeacher.educationLevel }}</div>
        <div class="detail-row"><strong>Status:</strong> <p-tag [value]="getVerificationStatusText(selectedTeacher.verificationStatus)" [severity]="getVerificationSeverity(selectedTeacher.verificationStatus)" /></div>
        <div class="detail-row"><strong>Active:</strong> {{ selectedTeacher.isActive ? 'Yes' : 'No' }}</div>
        <div class="detail-row" *ngIf="selectedTeacher.bio"><strong>Bio:</strong><p>{{ selectedTeacher.bio }}</p></div>
        <div class="detail-row" *ngIf="selectedTeacher.specializations"><strong>Specializations:</strong> {{ selectedTeacher.specializations }}</div>
      </div>
      <div class="flex gap-2 flex-wrap mt-4">
        <p-button label="Edit" icon="pi pi-pencil" [outlined]="true" (onClick)="openEditPopup(selectedTeacher); showTeacherDetails = false" />
        <p-button label="Reset password" icon="pi pi-key" [outlined]="true" (onClick)="onResetTeacherPassword(selectedTeacher)" />
        <p-button *ngIf="selectedTeacher.isActive" label="Suspend" severity="danger" [outlined]="true" (onClick)="onSetTeacherActive(selectedTeacher, false)" />
        <p-button *ngIf="!selectedTeacher.isActive" label="Activate" severity="success" [outlined]="true" (onClick)="onSetTeacherActive(selectedTeacher, true)" />
      </div>
    </ng-container>
    <ng-template pTemplate="footer">
      <p-button label="Close" (onClick)="closeTeacherDetails()" />
    </ng-template>
  </p-dialog>

  <p-dialog appendTo="body" header="Reject teacher" [(visible)]="showRejectDialog" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeRejectDialog()">
    <p *ngIf="rejectTeacherTarget" class="mb-3">Reject {{ rejectTeacherTarget.fullName }}? Enter the reason below.</p>
    <div class="field">
      <label for="rejectReason">Reason</label>
      <input pInputText id="rejectReason" type="text" [(ngModel)]="rejectReason" class="w-full" placeholder="Rejection reason (required)" />
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="closeRejectDialog()" />
      <p-button label="Reject" icon="pi pi-times" severity="danger" (onClick)="onConfirmReject()" [disabled]="!rejectReason.trim()" />
    </ng-template>
  </p-dialog>
</div>
