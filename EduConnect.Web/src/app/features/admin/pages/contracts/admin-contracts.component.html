<div class="admin-contracts page-container">
  <div class="page-header-compact">
    <div>
      <h1>One-To-One classes</h1>
      <p class="page-desc-short">Create a class by assigning a teacher and a student who has an active One-to-one subscription (add subscriptions on the Subscriptions page first).</p>
    </div>
  </div>

  <p-card styleClass="table-card">
    <p-toolbar>
      <ng-template pTemplate="start">
        <p-button label="New One-To-One class" icon="pi pi-plus" severity="success" (onClick)="openCreatePopup()" />
        <span class="filter-group">
          <p-dropdown appendTo="body" [(ngModel)]="filterTeacherId" [options]="teacherFilterOptions" optionLabel="label" optionValue="value" placeholder="Teachers" styleClass="filter-select" />
          <p-dropdown appendTo="body" [(ngModel)]="filterStudentId" [options]="studentFilterOptions" optionLabel="label" optionValue="value" placeholder="Students" styleClass="filter-select" />
          <p-dropdown appendTo="body" [(ngModel)]="filterStatus" [options]="statusFilterOptions" optionLabel="label" optionValue="value" placeholder="Status" styleClass="filter-select" />
          <p-button label="Apply" icon="pi pi-filter" (onClick)="applyContractFilters()" [outlined]="true" />
          <p-button label="Clear" severity="secondary" (onClick)="clearContractFilters()" [text]="true" />
        </span>
      </ng-template>
      <ng-template pTemplate="end">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search One-To-One classes" class="global-filter-input" />
        </span>
      </ng-template>
    </p-toolbar>
    <p-table
      #dt
      [value]="contracts"
      [loading]="loading"
      [globalFilterFields]="['contractId','teacherName','studentName']"
      [tableStyle]="{ 'min-width': '50rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} One-To-One classes"
      [showCurrentPageReport]="true">
      <ng-template pTemplate="header">
        <tr>
          <th style="width:3rem">#</th>
          <th>Class ID</th>
          <th>Teacher</th>
          <th>Student</th>
          <th>Schedule</th>
          <th>Subscription until</th>
          <th>Status</th>
          <th>Start</th>
          <th>End</th>
          <th style="width:6rem">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-c let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ c.contractId }}</td>
          <td>{{ c.teacherName }}</td>
          <td>{{ c.studentName }}</td>
          <td>{{ formatSchedule(c) }}</td>
          <td>{{ c.subscriptionPeriodEnd ? (c.subscriptionPeriodEnd | date:'shortDate') : '—' }}</td>
          <td><p-tag [value]="statusName(c.status)" [severity]="statusSeverity(c.status)" /></td>
          <td>{{ c.startDate | date:'shortDate' }}</td>
          <td>{{ c.endDate | date:'shortDate' }}</td>
          <td>
            <p-button
              *ngIf="c.status === 1"
              icon="pi pi-times"
              label="Cancel"
              severity="danger"
              [outlined]="true"
              size="small"
              (onClick)="cancelContract(c)" />
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10">
            <div class="empty-table-message">
              <i class="pi pi-file-edit empty-icon"></i>
              <p>No One-To-One classes found.</p>
              <p class="empty-hint">Adjust filters or create a new One-To-One class.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-dialog
    appendTo="body"
    header="New One-To-One class"
    [(visible)]="showCreatePopup"
    [modal]="true"
    [style]="{ width: '28rem' }"
    [draggable]="false"
    [resizable]="false"
    (onHide)="closeCreatePopup()">
    <form [formGroup]="createForm" (ngSubmit)="onSubmitCreate()" class="dialog-form">
      <div class="field">
        <label for="subscriptionId" class="label-required">Student (One-to-one subscription) <span class="required-asterisk">*</span></label>
        <p-dropdown appendTo="body" id="subscriptionId" formControlName="subscriptionId" [options]="subscriptionDropdownOptions" optionLabel="label" optionValue="value" placeholder="Select student with One-to-one subscription" styleClass="w-full" />
        <small class="text-color-secondary" *ngIf="oneToOneSubscriptions.length === 0 && showCreatePopup">No active One-to-one subscriptions. Add one on the Subscriptions page.</small>
        <small class="p-error" *ngIf="createForm.get('subscriptionId')?.invalid && createForm.get('subscriptionId')?.touched">Required</small>
      </div>
      <div class="field">
        <label for="teacherId" class="label-required">Teacher <span class="required-asterisk">*</span></label>
        <p-dropdown appendTo="body" id="teacherId" formControlName="teacherId" [options]="teacherDropdownOptions" optionLabel="label" optionValue="value" placeholder="Select teacher" styleClass="w-full" />
        <small class="p-error" *ngIf="createForm.get('teacherId')?.invalid && createForm.get('teacherId')?.touched">Required</small>
      </div>
      <div class="field">
        <label for="startDate">Start date (optional; subscription period is used when not set)</label>
        <p-calendar appendTo="body" id="startDate" formControlName="startDate" dateFormat="yy-mm-dd" placeholder="Select date" styleClass="w-full" [minDate]="startDateMinDate" [maxDate]="subscriptionMaxDate" />
        <small class="text-color-secondary" *ngIf="selectedSubscription">Start from today (or subscription start if later). End date must be within subscription ({{ selectedSubscription.startDate }} – {{ selectedSubscription.subscriptionPeriodEnd }}).</small>
      </div>
      <div class="field">
        <label for="endDate">End date (optional)</label>
        <p-calendar appendTo="body" id="endDate" formControlName="endDate" dateFormat="yy-mm-dd" placeholder="Select date" styleClass="w-full" [minDate]="endDateMinDate" [maxDate]="subscriptionMaxDate" />
        <small class="text-color-secondary" *ngIf="selectedSubscription">Must be on or after the selected start date and within the subscription period.</small>
      </div>
      <div class="field">
        <label>Days of week</label>
        <div class="days-checkboxes flex gap-2 flex-wrap">
          <div *ngFor="let d of createDayOptions" class="flex align-items-center gap-1">
            <p-checkbox [inputId]="'day-' + d.value" [(ngModel)]="d.checked" [ngModelOptions]="{standalone: true}" (ngModelChange)="onCreateDayChange()" [binary]="true" />
            <label [for]="'day-' + d.value" class="day-check">{{ d.label }}</label>
          </div>
        </div>
      </div>
      <div class="field">
        <label>Class schedule (optional)</label>
        <div class="flex gap-4 flex-wrap">
          <p-calendar appendTo="body" formControlName="startTime" [timeOnly]="true" hourFormat="12" placeholder="Start" styleClass="w-auto" [style]="{ minWidth: '8rem' }" />
          <p-calendar appendTo="body" formControlName="endTime" [timeOnly]="true" hourFormat="12" placeholder="End" styleClass="w-auto" [style]="{ minWidth: '8rem' }" />
        </div>
        <small class="text-color-secondary">Start and end time for this One-To-One class. End time must be after start time.</small>
      </div>
    </form>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="closeCreatePopup()" />
      <p-button label="Create" icon="pi pi-check" (onClick)="onSubmitCreate()" [disabled]="!createForm.valid" />
    </ng-template>
  </p-dialog>
</div>
