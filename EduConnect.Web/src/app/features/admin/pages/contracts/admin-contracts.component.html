<div class="admin-contracts">
  <div class="page-header-compact">
    <div>
      <h1>Contracts</h1>
      <p class="page-desc-short">Create and manage teacherâ€“student contracts. Filter by teacher, student, or status.</p>
    </div>
  </div>

  <p-card>
    <p-toolbar styleClass="mb-2">
      <ng-template pTemplate="start">
        <p-button label="New contract" icon="pi pi-plus" severity="success" (onClick)="openCreatePopup()" />
        <span class="filter-group">
          <select [(ngModel)]="filterTeacherId" class="p-inputtext filter-select">
            <option [ngValue]="null">All teachers</option>
            <option *ngFor="let t of teachers" [ngValue]="t.id">{{ t.firstName }} {{ t.lastName }}</option>
          </select>
          <select [(ngModel)]="filterStudentId" class="p-inputtext filter-select">
            <option [ngValue]="null">All students</option>
            <option *ngFor="let s of students" [ngValue]="s.id">{{ s.firstName }} {{ s.lastName }}</option>
          </select>
          <select [(ngModel)]="filterStatus" class="p-inputtext filter-select">
            <option [ngValue]="null">All statuses</option>
            <option *ngFor="let o of statusOptions" [ngValue]="o.value">{{ o.label }}</option>
          </select>
          <p-button label="Apply" icon="pi pi-filter" (onClick)="applyContractFilters()" [outlined]="true" />
          <p-button label="Clear" severity="secondary" (onClick)="clearContractFilters()" [text]="true" />
        </span>
      </ng-template>
      <ng-template pTemplate="end">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search contracts" class="global-filter-input" />
        </span>
      </ng-template>
    </p-toolbar>
    <p-table
      #dt
      [value]="contracts"
      [loading]="loading"
      [globalFilterFields]="['contractId','teacherName','studentName']"
      [tableStyle]="{ 'min-width': '50rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} contracts"
      [showCurrentPageReport]="true">
      <ng-template pTemplate="header">
        <tr>
          <th style="width:3rem">#</th>
          <th>Contract ID</th>
          <th>Teacher</th>
          <th>Student</th>
          <th pSortableColumn="packageHours">Package <p-sortIcon field="packageHours" /></th>
          <th pSortableColumn="remainingHours">Remaining <p-sortIcon field="remainingHours" /></th>
          <th>Status</th>
          <th>Start</th>
          <th>End</th>
          <th style="width:6rem">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-c let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ c.contractId }}</td>
          <td>{{ c.teacherName }}</td>
          <td>{{ c.studentName }}</td>
          <td>{{ c.packageHours }}</td>
          <td>{{ c.remainingHours }}</td>
          <td><p-tag [value]="statusName(c.status)" [severity]="statusSeverity(c.status)" /></td>
          <td>{{ c.startDate | date:'shortDate' }}</td>
          <td>{{ c.endDate | date:'shortDate' }}</td>
          <td>
            <p-button
              *ngIf="c.status === 1"
              icon="pi pi-times"
              label="Cancel"
              severity="danger"
              [outlined]="true"
              size="small"
              (onClick)="cancelContract(c)" />
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10">
            <div class="empty-table-message">
              <i class="pi pi-file-edit empty-icon"></i>
              <p>No contracts found.</p>
              <p class="empty-hint">Adjust filters or create a new contract.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <p-dialog
    header="New contract"
    [(visible)]="showCreatePopup"
    [modal]="true"
    [style]="{ width: '28rem' }"
    [draggable]="false"
    [resizable]="false"
    (onHide)="closeCreatePopup()">
    <form [formGroup]="createForm" (ngSubmit)="onSubmitCreate()" class="dialog-form">
      <div class="field">
        <label for="teacherId">Teacher</label>
        <select id="teacherId" formControlName="teacherId" class="p-inputtext w-full">
          <option [ngValue]="null">Select teacher</option>
          <option *ngFor="let t of teachers" [ngValue]="t.id">{{ t.firstName }} {{ t.lastName }}</option>
        </select>
        <small class="p-error" *ngIf="createForm.get('teacherId')?.invalid && createForm.get('teacherId')?.touched">Required</small>
      </div>
      <div class="field">
        <label for="studentId">Student</label>
        <select id="studentId" formControlName="studentId" class="p-inputtext w-full">
          <option [ngValue]="null">Select student</option>
          <option *ngFor="let s of students" [ngValue]="s.id">{{ s.firstName }} {{ s.lastName }} ({{ s.gradeLevelName }})</option>
        </select>
        <small class="p-error" *ngIf="createForm.get('studentId')?.invalid && createForm.get('studentId')?.touched">Required</small>
      </div>
      <div class="field">
        <label for="packageHours">Package hours</label>
        <input pInputText id="packageHours" type="number" formControlName="packageHours" min="1" class="w-full" />
      </div>
      <div class="field">
        <label for="startDate">Start date</label>
        <input pInputText id="startDate" type="date" formControlName="startDate" class="w-full" />
      </div>
      <div class="field">
        <label for="endDate">End date (optional)</label>
        <input pInputText id="endDate" type="date" formControlName="endDate" class="w-full" />
      </div>
    </form>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="closeCreatePopup()" />
      <p-button label="Create" icon="pi pi-check" (onClick)="onSubmitCreate()" [disabled]="!createForm.valid" />
    </ng-template>
  </p-dialog>
</div>
