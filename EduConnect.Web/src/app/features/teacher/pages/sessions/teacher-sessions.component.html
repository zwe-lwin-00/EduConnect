<div class="teacher-sessions page-container">
  <div class="page-header-compact">
    <div>
      <h1>Sessions</h1>
      <p class="page-desc-short">Check-in 1:1 or start a group session. Check-out with lesson notes. Zoom link in Profile or per group class.</p>
    </div>
  </div>

  <p-message *ngIf="error" severity="error" [text]="error" styleClass="w-full mb-3" />

  <div *ngIf="loading" class="empty-table-message">
    <p-progressSpinner strokeWidth="4" styleClass="mb-2" [style]="{ width: '40px', height: '40px' }" />
    <p>Loading sessions...</p>
  </div>

  <ng-container *ngIf="!loading && !error">
    <p-card header="1:1 in progress" styleClass="mb-3">
      <div *ngIf="todaySessions.length === 0" class="empty-table-message">
        <i class="pi pi-calendar empty-icon"></i>
        <p>None. Start one below.</p>
      </div>
      <div *ngFor="let s of todaySessions" class="session-card">
        <div class="session-info">
          <strong>{{ s.studentName }}</strong> – {{ s.contractIdDisplay }}
          <span class="status">Status: {{ s.status }}</span>
        </div>
        <div class="session-meta" *ngIf="s.checkInTime">Check-in: {{ s.checkInTime | displayDate:'short' }}</div>
        <div class="session-meta" *ngIf="s.checkOutTime">Check-out: {{ s.checkOutTime | displayDate:'short' }}</div>
        <div class="session-actions">
          <a *ngIf="s.zoomJoinUrl" [href]="s.zoomJoinUrl" target="_blank" rel="noopener noreferrer" class="btn-zoom mr-2">Join Zoom</a>
          <p-button *ngIf="s.canCheckOut" label="Check-out (add notes)" icon="pi pi-check" (onClick)="openCheckOut(s)" />
        </div>
      </div>
    </p-card>

    <p-card header="Start 1:1" styleClass="mb-3">
      <div *ngIf="upcomingSessions.length === 0" class="empty-table-message">
        <i class="pi pi-users empty-icon"></i>
        <p>No One-To-One sessions to start.</p>
      </div>
      <div *ngFor="let s of upcomingSessions" class="session-card">
        <div class="session-info">
          <strong>{{ s.studentName }}</strong> – {{ s.contractIdDisplay }}
        </div>
        <div class="session-actions">
          <p-button label="Check-in" icon="pi pi-play" severity="success" (onClick)="checkIn(s.contractId)" [loading]="checkingInContractId === s.contractId" [disabled]="checkingInContractId === s.contractId" />
        </div>
      </div>
    </p-card>

    <p-card header="Group session" styleClass="mb-3">
      <div *ngIf="inProgressGroupSession" class="session-card group-session">
        <div class="session-info">
          <strong>{{ inProgressGroupSession.groupClassName }}</strong> – In progress
          <span class="status">Started {{ inProgressGroupSession.checkInTime | displayDate:'short' }}</span>
        </div>
        <div class="session-actions">
          <a *ngIf="inProgressGroupSession.zoomJoinUrl" [href]="inProgressGroupSession.zoomJoinUrl" target="_blank" rel="noopener noreferrer" class="btn-zoom mr-2">Join Zoom</a>
          <p-button label="Check-out group (add notes)" icon="pi pi-check" (onClick)="openGroupCheckOut(inProgressGroupSession)" />
        </div>
      </div>
      <div *ngIf="!inProgressGroupSession" class="group-start flex gap-2 flex-wrap align-items-center">
        <p-dropdown appendTo="body" [(ngModel)]="selectedGroupClassId" [options]="groupClassOptions" optionLabel="label" optionValue="value" placeholder="Select group class" styleClass="group-select" [style]="{ minWidth: '16rem' }" />
        <p-button label="Start group session" icon="pi pi-play" severity="success" (onClick)="startGroupSession()" [loading]="!!checkingInGroupClassId" [disabled]="!selectedGroupClassId || !!checkingInGroupClassId" />
      </div>
      <p class="hint mt-2"><a routerLink="/teacher/group-classes">Group classes</a> → edit name, Zoom, enroll students</p>
    </p-card>

    <p-dialog appendTo="body" header="Check-out 1:1" [visible]="!!checkingOutSession" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" [resizable]="false" (onHide)="closeCheckOut()" *ngIf="checkingOutSession">
      <p class="mb-3"><strong>{{ checkingOutSession.studentName }}</strong> – {{ checkingOutSession.contractIdDisplay }}</p>
      <div class="field">
        <label>Lesson notes *</label>
        <textarea pTextarea [(ngModel)]="lessonNotes" class="w-full" rows="4" placeholder="Enter lesson notes (required)"></textarea>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="closeCheckOut()" />
        <p-button label="Check-out" icon="pi pi-check" (onClick)="submitCheckOut()" [disabled]="!lessonNotes.trim()" />
      </ng-template>
    </p-dialog>

    <p-dialog appendTo="body" header="Check-out group" [visible]="!!checkingOutGroupSession" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" [resizable]="false" (onHide)="closeGroupCheckOut()" *ngIf="checkingOutGroupSession">
      <p class="mb-3"><strong>{{ checkingOutGroupSession.groupClassName }}</strong></p>
      <div class="field">
        <label>Lesson notes *</label>
        <textarea pTextarea [(ngModel)]="groupLessonNotes" class="w-full" rows="4" placeholder="Enter lesson notes (required)"></textarea>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="closeGroupCheckOut()" />
        <p-button label="Check-out group" icon="pi pi-check" (onClick)="submitGroupCheckOut()" [disabled]="!groupLessonNotes.trim()" />
      </ng-template>
    </p-dialog>
  </ng-container>
</div>
