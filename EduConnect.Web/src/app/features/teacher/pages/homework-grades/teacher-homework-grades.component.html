<div class="teacher-homework-grades page-container">
  <div class="page-header-compact">
    <div>
      <h1>Homework &amp; Grades</h1>
      <p class="page-desc-short">Assign homework to your students and record grades. Parents can view these in their student's learning overview.</p>
    </div>
  </div>

  <p-message *ngIf="error" severity="error" [text]="error" styleClass="w-full mb-3" />

  <div *ngIf="loading" class="empty-table-message">
    <p-progressSpinner strokeWidth="4" styleClass="mb-2" [style]="{ width: '40px', height: '40px' }" />
    <span class="text-color-secondary">Loading...</span>
  </div>

  <ng-container *ngIf="!loading && !error">
    <p-card styleClass="filter-card">
      <div class="filter-bar flex gap-2 flex-wrap align-items-center">
        <label>Student:</label>
        <p-dropdown appendTo="body" [(ngModel)]="filterStudentId" [options]="studentFilterOptions" optionLabel="label" optionValue="value" (ngModelChange)="onFilterChange()" placeholder="All students" styleClass="filter-select" />
        <label>Homework due:</label>
        <p-calendar appendTo="body" [(ngModel)]="dueDateFromModel" (ngModelChange)="onFilterChange()" dateFormat="yy-mm-dd" placeholder="From" styleClass="filter-date" [style]="{ minWidth: '8rem' }" [maxDate]="maxDateForSince" />
        <span class="filter-sep">–</span>
        <p-calendar appendTo="body" [(ngModel)]="dueDateToModel" (ngModelChange)="onFilterChange()" dateFormat="yy-mm-dd" placeholder="To" styleClass="filter-date" [style]="{ minWidth: '8rem' }" />
        <label>Grade date:</label>
        <p-calendar appendTo="body" [(ngModel)]="gradeDateFromModel" (ngModelChange)="onFilterChange()" dateFormat="yy-mm-dd" placeholder="From" styleClass="filter-date" [style]="{ minWidth: '8rem' }" [maxDate]="maxDateForSince" />
        <span class="filter-sep">–</span>
        <p-calendar appendTo="body" [(ngModel)]="gradeDateToModel" (ngModelChange)="onFilterChange()" dateFormat="yy-mm-dd" placeholder="To" styleClass="filter-date" [style]="{ minWidth: '8rem' }" />
        <p-button label="Clear dates" [outlined]="true" severity="secondary" (onClick)="clearDateFilters()" />
      </div>
    </p-card>

    <p-card header="Homework">
      <div class="card-actions-top">
        <p-button label="Assign homework" icon="pi pi-plus" severity="success" (onClick)="openHomeworkForm()" />
      </div>
      <div *ngIf="homeworks.length === 0" class="empty-state">No homework yet.</div>
      <div *ngFor="let h of homeworks" class="item-card">
        <div class="item-header">
          <strong>{{ h.title }}</strong> · {{ h.studentName }}
          <span *ngIf="h.contractIdDisplay"> · {{ h.contractIdDisplay }}</span>
          · Due {{ h.dueDate | date:'shortDate' }} · <p-tag [value]="h.statusText" [severity]="h.status === 2 ? 'success' : h.status === 1 ? 'info' : 'secondary'" />
        </div>
        <div class="item-body" *ngIf="h.description">{{ h.description }}</div>
        <div class="item-body" *ngIf="h.teacherFeedback"><strong>Your feedback:</strong> {{ h.teacherFeedback }}</div>
        <div class="item-actions">
          <p-button *ngIf="h.status === 1" label="Mark submitted" [outlined]="true" size="small" (onClick)="markSubmitted(h)" />
          <p-button *ngIf="h.status === 1 || h.status === 2" label="Mark graded + feedback" icon="pi pi-check" [outlined]="true" size="small" (onClick)="openGrading(h)" />
        </div>
      </div>
    </p-card>

    <p-card header="Grades">
      <div class="card-actions-top">
        <p-button label="Add grade" icon="pi pi-plus" severity="success" (onClick)="openGradeForm()" />
      </div>
      <div *ngIf="grades.length === 0" class="empty-state">No grades yet.</div>
      <div *ngFor="let g of grades" class="item-card">
        <div class="item-header">
          <strong>{{ g.title }}</strong> · {{ g.studentName }}
          <span *ngIf="g.contractIdDisplay"> · {{ g.contractIdDisplay }}</span>
          · {{ g.gradeValue }}{{ g.maxValue != null ? ' / ' + g.maxValue : '' }} · {{ g.gradeDate | date:'shortDate' }}
        </div>
        <div class="item-body" *ngIf="g.notes">{{ g.notes }}</div>
      </div>
    </p-card>

    <p-dialog appendTo="body" header="Assign homework" [(visible)]="showHomeworkForm" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeHomeworkForm()">
      <div class="dialog-form">
        <div class="field">
          <label>Student *</label>
          <p-dropdown appendTo="body" [(ngModel)]="homeworkForm.studentId" [options]="studentOptions" optionLabel="label" optionValue="value" placeholder="Select student" styleClass="w-full" />
        </div>
        <div class="field">
          <label>Title *</label>
          <input pInputText type="text" [(ngModel)]="homeworkForm.title" class="w-full" placeholder="e.g. Math Ch.5 exercises" />
        </div>
        <div class="field">
          <label>Description</label>
          <textarea pTextarea [(ngModel)]="homeworkForm.description" class="w-full" rows="3"></textarea>
        </div>
        <div class="field">
          <label>Due date *</label>
          <p-calendar appendTo="body" [(ngModel)]="homeworkDueDateModel" dateFormat="yy-mm-dd" placeholder="Select date" styleClass="w-full" />
        </div>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="closeHomeworkForm()" />
        <p-button label="Assign" icon="pi pi-check" (onClick)="submitHomework()" [loading]="homeworkSubmitting" [disabled]="!homeworkForm.title.trim()" />
      </ng-template>
    </p-dialog>

    <p-dialog appendTo="body" header="Add grade" [(visible)]="showGradeForm" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeGradeForm()">
      <div class="dialog-form">
        <div class="field">
          <label>Student *</label>
          <p-dropdown appendTo="body" [(ngModel)]="gradeForm.studentId" [options]="studentOptions" optionLabel="label" optionValue="value" placeholder="Select student" styleClass="w-full" />
        </div>
        <div class="field">
          <label>Title *</label>
          <input pInputText type="text" [(ngModel)]="gradeForm.title" class="w-full" placeholder="e.g. Quiz 1, Mid-term" />
        </div>
        <div class="field">
          <label>Grade value *</label>
          <input pInputText type="text" [(ngModel)]="gradeForm.gradeValue" class="w-full" placeholder="e.g. A, 85, Pass" />
        </div>
        <div class="field">
          <label>Max value (optional)</label>
          <p-inputNumber [(ngModel)]="gradeForm.maxValue" [min]="0" [minFractionDigits]="0" [maxFractionDigits]="2" placeholder="e.g. 100" styleClass="w-full" inputStyleClass="w-full" />
        </div>
        <div class="field">
          <label>Date *</label>
          <p-calendar appendTo="body" [(ngModel)]="gradeDateFormModel" dateFormat="yy-mm-dd" placeholder="Select date" styleClass="w-full" />
        </div>
        <div class="field">
          <label>Notes</label>
          <textarea pTextarea [(ngModel)]="gradeForm.notes" class="w-full" rows="2"></textarea>
        </div>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="closeGradeForm()" />
        <p-button label="Add grade" icon="pi pi-check" (onClick)="submitGrade()" [loading]="gradeSubmitting" [disabled]="!gradeForm.title.trim() || !gradeForm.gradeValue.trim()" />
      </ng-template>
    </p-dialog>

    <p-dialog appendTo="body" header="Mark as graded – Add feedback" [visible]="gradingHomeworkId != null" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeGrading()" *ngIf="gradingHomeworkId">
      <div class="dialog-form">
        <div class="field">
          <label>Teacher feedback (optional)</label>
          <textarea pTextarea [(ngModel)]="gradingFeedback" class="w-full" rows="4" placeholder="Feedback for the student/parent"></textarea>
        </div>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="closeGrading()" />
        <p-button label="Mark graded" icon="pi pi-check" (onClick)="submitGrading()" />
      </ng-template>
    </p-dialog>
  </ng-container>
</div>
