<div class="teacher-homework-grades">
  <h1>Homework & Grades</h1>
  <p class="page-desc">Assign homework to your students and record grades. Parents can view these in their student's learning overview.</p>

  <div *ngIf="loading" class="loading">Loading...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <ng-container *ngIf="!loading && !error">
    <div class="filter-bar">
      <label>Student:</label>
      <select [(ngModel)]="filterStudentId" (ngModelChange)="onFilterChange()" class="form-control filter-select">
        <option [ngValue]="null">All students</option>
        <option *ngFor="let s of students" [ngValue]="s.studentId">{{ s.studentName }} ({{ s.contractIdDisplay }})</option>
      </select>
      <label class="filter-label">Homework due:</label>
      <input type="date" [(ngModel)]="dueDateFrom" (ngModelChange)="onFilterChange()" class="form-control filter-date" title="Due from" />
      <span class="filter-sep">–</span>
      <input type="date" [(ngModel)]="dueDateTo" (ngModelChange)="onFilterChange()" class="form-control filter-date" title="Due to" />
      <label class="filter-label">Grade date:</label>
      <input type="date" [(ngModel)]="gradeDateFrom" (ngModelChange)="onFilterChange()" class="form-control filter-date" title="Grade date from" />
      <span class="filter-sep">–</span>
      <input type="date" [(ngModel)]="gradeDateTo" (ngModelChange)="onFilterChange()" class="form-control filter-date" title="Grade date to" />
      <button type="button" class="btn btn-outline" (click)="clearDateFilters()">Clear dates</button>
    </div>

    <section class="section">
      <h2>Homework</h2>
      <button type="button" class="btn btn-success" (click)="openHomeworkForm()">Assign homework</button>
      <div *ngIf="homeworks.length === 0" class="empty">No homework yet.</div>
      <div *ngFor="let h of homeworks" class="card">
        <div class="card-header">
          <strong>{{ h.title }}</strong> · {{ h.studentName }}
          <span *ngIf="h.contractIdDisplay"> · {{ h.contractIdDisplay }}</span>
          · Due {{ h.dueDate | date:'shortDate' }} · <span class="status-badge" [class]="'status-' + h.status">{{ h.statusText }}</span>
        </div>
        <div class="card-body" *ngIf="h.description">{{ h.description }}</div>
        <div class="card-body" *ngIf="h.teacherFeedback"><strong>Your feedback:</strong> {{ h.teacherFeedback }}</div>
        <div class="card-actions">
          <button *ngIf="h.status === 1" type="button" class="btn btn-sm" (click)="markSubmitted(h)">Mark submitted</button>
          <button *ngIf="h.status === 1 || h.status === 2" type="button" class="btn btn-sm btn-primary" (click)="openGrading(h)">Mark graded + feedback</button>
        </div>
      </div>
    </section>

    <section class="section">
      <h2>Grades</h2>
      <button type="button" class="btn btn-success" (click)="openGradeForm()">Add grade</button>
      <div *ngIf="grades.length === 0" class="empty">No grades yet.</div>
      <div *ngFor="let g of grades" class="card">
        <div class="card-header">
          <strong>{{ g.title }}</strong> · {{ g.studentName }}
          <span *ngIf="g.contractIdDisplay"> · {{ g.contractIdDisplay }}</span>
          · {{ g.gradeValue }}{{ g.maxValue != null ? ' / ' + g.maxValue : '' }} · {{ g.gradeDate | date:'shortDate' }}
        </div>
        <div class="card-body" *ngIf="g.notes">{{ g.notes }}</div>
      </div>
    </section>

    <div *ngIf="showHomeworkForm" class="modal-overlay" (click)="closeHomeworkForm()">
      <div class="modal" (click)="$event.stopPropagation()">
        <h3>Assign homework</h3>
        <div class="form-group">
          <label>Student *</label>
          <select [(ngModel)]="homeworkForm.studentId" class="form-control">
            <option *ngFor="let s of students" [value]="s.studentId">{{ s.studentName }} ({{ s.contractIdDisplay }})</option>
          </select>
        </div>
        <div class="form-group">
          <label>Title *</label>
          <input type="text" [(ngModel)]="homeworkForm.title" class="form-control" placeholder="e.g. Math Ch.5 exercises" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="homeworkForm.description" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Due date *</label>
          <input type="date" [(ngModel)]="homeworkForm.dueDate" class="form-control" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn" (click)="closeHomeworkForm()">Cancel</button>
          <button type="button" class="btn btn-success" (click)="submitHomework()" [disabled]="!homeworkForm.title.trim() || homeworkSubmitting">{{ homeworkSubmitting ? 'Saving...' : 'Assign' }}</button>
        </div>
      </div>
    </div>

    <div *ngIf="showGradeForm" class="modal-overlay" (click)="closeGradeForm()">
      <div class="modal" (click)="$event.stopPropagation()">
        <h3>Add grade</h3>
        <div class="form-group">
          <label>Student *</label>
          <select [(ngModel)]="gradeForm.studentId" class="form-control">
            <option *ngFor="let s of students" [value]="s.studentId">{{ s.studentName }} ({{ s.contractIdDisplay }})</option>
          </select>
        </div>
        <div class="form-group">
          <label>Title *</label>
          <input type="text" [(ngModel)]="gradeForm.title" class="form-control" placeholder="e.g. Quiz 1, Mid-term" />
        </div>
        <div class="form-group">
          <label>Grade value *</label>
          <input type="text" [(ngModel)]="gradeForm.gradeValue" class="form-control" placeholder="e.g. A, 85, Pass" />
        </div>
        <div class="form-group">
          <label>Max value (optional)</label>
          <input type="number" [(ngModel)]="gradeForm.maxValue" class="form-control" placeholder="e.g. 100" min="0" step="0.01" />
        </div>
        <div class="form-group">
          <label>Date *</label>
          <input type="date" [(ngModel)]="gradeForm.gradeDate" class="form-control" />
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea [(ngModel)]="gradeForm.notes" class="form-control" rows="2"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" (click)="closeGradeForm()">Cancel</button>
          <button type="button" class="btn btn-success" (click)="submitGrade()" [disabled]="!gradeForm.title.trim() || !gradeForm.gradeValue.trim() || gradeSubmitting">{{ gradeSubmitting ? 'Saving...' : 'Add grade' }}</button>
        </div>
      </div>
    </div>

    <div *ngIf="gradingHomeworkId" class="modal-overlay" (click)="closeGrading()">
      <div class="modal" (click)="$event.stopPropagation()">
        <h3>Mark as graded – Add feedback</h3>
        <div class="form-group">
          <label>Teacher feedback (optional)</label>
          <textarea [(ngModel)]="gradingFeedback" class="form-control" rows="4" placeholder="Feedback for the student/parent"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" (click)="closeGrading()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="submitGrading()">Mark graded</button>
        </div>
      </div>
    </div>
  </ng-container>
</div>
