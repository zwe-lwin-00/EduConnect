<div class="teacher-homework-grades">
  <div class="page-header-compact">
    <div>
      <h1>Homework &amp; Grades</h1>
      <p class="page-desc-short">Assign homework to your students and record grades. Parents can view these in their student's learning overview.</p>
    </div>
  </div>

  <p-message *ngIf="error" severity="error" [text]="error" styleClass="w-full mb-3" />

  <div *ngIf="loading" class="p-4 text-center text-color-secondary"><i class="pi pi-spin pi-spinner mr-2"></i>Loading...</div>

  <ng-container *ngIf="!loading && !error">
    <p-card styleClass="filter-card">
      <div class="filter-bar">
        <label>Student:</label>
        <select [(ngModel)]="filterStudentId" (ngModelChange)="onFilterChange()" class="p-inputtext filter-select">
          <option [ngValue]="null">All students</option>
          <option *ngFor="let s of students" [ngValue]="s.studentId">{{ s.studentName }} ({{ s.contractIdDisplay }})</option>
        </select>
        <label>Homework due:</label>
        <input pInputText type="date" [(ngModel)]="dueDateFrom" (ngModelChange)="onFilterChange()" class="filter-date" title="Due from" />
        <span class="filter-sep">–</span>
        <input pInputText type="date" [(ngModel)]="dueDateTo" (ngModelChange)="onFilterChange()" class="filter-date" title="Due to" />
        <label>Grade date:</label>
        <input pInputText type="date" [(ngModel)]="gradeDateFrom" (ngModelChange)="onFilterChange()" class="filter-date" title="Grade date from" />
        <span class="filter-sep">–</span>
        <input pInputText type="date" [(ngModel)]="gradeDateTo" (ngModelChange)="onFilterChange()" class="filter-date" title="Grade date to" />
        <p-button label="Clear dates" [outlined]="true" severity="secondary" (onClick)="clearDateFilters()" />
      </div>
    </p-card>

    <p-card header="Homework">
      <div class="card-actions-top">
        <p-button label="Assign homework" icon="pi pi-plus" severity="success" (onClick)="openHomeworkForm()" />
      </div>
      <div *ngIf="homeworks.length === 0" class="empty-state">No homework yet.</div>
      <div *ngFor="let h of homeworks" class="item-card">
        <div class="item-header">
          <strong>{{ h.title }}</strong> · {{ h.studentName }}
          <span *ngIf="h.contractIdDisplay"> · {{ h.contractIdDisplay }}</span>
          · Due {{ h.dueDate | date:'shortDate' }} · <p-tag [value]="h.statusText" [severity]="h.status === 2 ? 'success' : h.status === 1 ? 'info' : 'secondary'" />
        </div>
        <div class="item-body" *ngIf="h.description">{{ h.description }}</div>
        <div class="item-body" *ngIf="h.teacherFeedback"><strong>Your feedback:</strong> {{ h.teacherFeedback }}</div>
        <div class="item-actions">
          <p-button *ngIf="h.status === 1" label="Mark submitted" [outlined]="true" size="small" (onClick)="markSubmitted(h)" />
          <p-button *ngIf="h.status === 1 || h.status === 2" label="Mark graded + feedback" icon="pi pi-check" [outlined]="true" size="small" (onClick)="openGrading(h)" />
        </div>
      </div>
    </p-card>

    <p-card header="Grades">
      <div class="card-actions-top">
        <p-button label="Add grade" icon="pi pi-plus" severity="success" (onClick)="openGradeForm()" />
      </div>
      <div *ngIf="grades.length === 0" class="empty-state">No grades yet.</div>
      <div *ngFor="let g of grades" class="item-card">
        <div class="item-header">
          <strong>{{ g.title }}</strong> · {{ g.studentName }}
          <span *ngIf="g.contractIdDisplay"> · {{ g.contractIdDisplay }}</span>
          · {{ g.gradeValue }}{{ g.maxValue != null ? ' / ' + g.maxValue : '' }} · {{ g.gradeDate | date:'shortDate' }}
        </div>
        <div class="item-body" *ngIf="g.notes">{{ g.notes }}</div>
      </div>
    </p-card>

    <p-dialog header="Assign homework" [(visible)]="showHomeworkForm" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeHomeworkForm()">
      <div class="dialog-form">
        <div class="field">
          <label>Student *</label>
          <select [(ngModel)]="homeworkForm.studentId" class="p-inputtext w-full">
            <option *ngFor="let s of students" [ngValue]="s.studentId">{{ s.studentName }} ({{ s.contractIdDisplay }})</option>
          </select>
        </div>
        <div class="field">
          <label>Title *</label>
          <input pInputText type="text" [(ngModel)]="homeworkForm.title" class="w-full" placeholder="e.g. Math Ch.5 exercises" />
        </div>
        <div class="field">
          <label>Description</label>
          <textarea pInputText [(ngModel)]="homeworkForm.description" class="w-full" rows="3"></textarea>
        </div>
        <div class="field">
          <label>Due date *</label>
          <input pInputText type="date" [(ngModel)]="homeworkForm.dueDate" class="w-full" />
        </div>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="closeHomeworkForm()" />
        <p-button label="Assign" icon="pi pi-check" (onClick)="submitHomework()" [loading]="homeworkSubmitting" [disabled]="!homeworkForm.title.trim()" />
      </ng-template>
    </p-dialog>

    <p-dialog header="Add grade" [(visible)]="showGradeForm" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeGradeForm()">
      <div class="dialog-form">
        <div class="field">
          <label>Student *</label>
          <select [(ngModel)]="gradeForm.studentId" class="p-inputtext w-full">
            <option *ngFor="let s of students" [ngValue]="s.studentId">{{ s.studentName }} ({{ s.contractIdDisplay }})</option>
          </select>
        </div>
        <div class="field">
          <label>Title *</label>
          <input pInputText type="text" [(ngModel)]="gradeForm.title" class="w-full" placeholder="e.g. Quiz 1, Mid-term" />
        </div>
        <div class="field">
          <label>Grade value *</label>
          <input pInputText type="text" [(ngModel)]="gradeForm.gradeValue" class="w-full" placeholder="e.g. A, 85, Pass" />
        </div>
        <div class="field">
          <label>Max value (optional)</label>
          <input pInputText type="number" [(ngModel)]="gradeForm.maxValue" class="w-full" placeholder="e.g. 100" min="0" step="0.01" />
        </div>
        <div class="field">
          <label>Date *</label>
          <input pInputText type="date" [(ngModel)]="gradeForm.gradeDate" class="w-full" />
        </div>
        <div class="field">
          <label>Notes</label>
          <textarea pInputText [(ngModel)]="gradeForm.notes" class="w-full" rows="2"></textarea>
        </div>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="closeGradeForm()" />
        <p-button label="Add grade" icon="pi pi-check" (onClick)="submitGrade()" [loading]="gradeSubmitting" [disabled]="!gradeForm.title.trim() || !gradeForm.gradeValue.trim()" />
      </ng-template>
    </p-dialog>

    <p-dialog header="Mark as graded – Add feedback" [visible]="gradingHomeworkId != null" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" (onHide)="closeGrading()" *ngIf="gradingHomeworkId">
      <div class="dialog-form">
        <div class="field">
          <label>Teacher feedback (optional)</label>
          <textarea pInputText [(ngModel)]="gradingFeedback" class="w-full" rows="4" placeholder="Feedback for the student/parent"></textarea>
        </div>
      </div>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" severity="secondary" (onClick)="closeGrading()" />
        <p-button label="Mark graded" icon="pi pi-check" (onClick)="submitGrading()" />
      </ng-template>
    </p-dialog>
  </ng-container>
</div>
